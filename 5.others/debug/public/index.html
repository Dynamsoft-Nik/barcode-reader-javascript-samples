<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta name="description" content="Read barcodes from camera with Dynamsoft Barcode Reader. Save the processed frames for debugging.">
    <meta name="keywords" content="read barcode from camera, debug">
    <meta name="viewport" content="width=device-width,initial-scale=1.0">
</head>

<body>
    <h1 style="font-size: 1.5em;">Read Barcodes from Camera - Debug</h1>
    <button id="btn-show-scanner">show scanner</button>
    <br>
    <label><input type="radio" name="video-settings" checked value="default">default</label>
    <label><input type="radio" name="video-settings" value="back-camera">back camera</label>
    <label><input type="radio" name="video-settings" value="only-video">only video</label>
    <br>
    <label><input id="cb-send-img" type="checkbox">send image to</label><input id="ipt-server-url" placeholder="server url, default ./collect">
    <br>
    <div id="div-video-container" style="width:100%;height:calc(100vh - 150px);"></div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/eruda/2.4.1/eruda.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dynamsoft-javascript-barcode@8.8.7/dist/dbr.js"></script>
    <script>
        eruda.init();
        Dynamsoft.DBR.BarcodeReader._onLog = console.log;
        /** LICENSE ALERT - README
         *
         * The library requires a license to work.
         * If the license is not specified, a free public trial license will be used by default which is the case in this sample.
         * Note that network connection is required for the public license to work.
         * For more info, please check https://www.dynamsoft.com/barcode-reader/programming/javascript/user-guide/?ver=8.8.7&utm_source=github#specify-the-license or contact support@dynamsoft.com.
         */

        /* When using your own license, uncomment the following line and specify your license. */

        // Dynamsoft.DBR.BarcodeReader.license = "YOUR-ORGANIZATION-ID or YOUR-HANDSHAKECODE or AN-OFFLINE-LICENSE or ANY-OTHER-TYPE-OF-SUPPORTED-LICENSE-STRING";

        /** LICENSE ALERT - THE END */

        let pScanner = null;
        // decode video from camera
        document.getElementById('btn-show-scanner').addEventListener('click', async() => {
            try {
                let scanner = await (pScanner = pScanner || Dynamsoft.DBR.BarcodeScanner.createInstance());
                scanner.bPlaySoundOnSuccessfulRead = true;
                let rs = await scanner.getRuntimeSettings();
                rs.timeout = 100000;
                await scanner.updateRuntimeSettings(rs);
                let ss = await scanner.getScanSettings();
                ss.intervalTime = 100;
                await scanner.updateScanSettings(ss);
                scanner.ifSaveOriginalImageInACanvas = true;
                let processingCount = 0;
                scanner.onFrameRead = async results => {
                    let bSendImg = !!document.getElementById("cb-send-img").checked;
                    /**
                     * The barcode reading speed is very fast, we must limit 
                     * the number of uploaded frames (4), so that it is feasible.
                     */
                    if (bSendImg && processingCount < 4) {
                        ++processingCount;
                        try {
                            /**
                             * The original image is the one the reader worked on,
                             * we can collect it for futher testing and debugging.
                             */
                            let cvs = await scanner.getOriginalImageInACanvas();
                            let fd = new FormData();
                            if (cvs != null) {
                                let blob = cvs.convertToBlob ?
                                    await cvs.convertToBlob() :
                                    await new Promise(resolve => {
                                        cvs.toBlob(blob => resolve(blob));
                                    });
                                fd.append("img", blob);
                                await fetch(document.getElementById("ipt-server-url").value || "collect", {
                                    method: "POST",
                                    body: fd
                                });
                            }
                        } catch (ex) {
                            console.error(ex);
                        }
                        --processingCount;
                    }
                };
                document.getElementById('div-video-container').appendChild(scanner.getUIElement());
                await scanner.show();
            } catch (ex) {
                alert(ex.message);
                throw ex;
            }
        });

        let switchVideoSettings = async() => {
            if (!pScanner) return;
            let scanner = await pScanner;
            switch (document.querySelector('input[name="video-settings"]:checked').value) {
                case "back-camera":
                    await scanner.updateVideoSettings({
                        video: {
                            facingMode: "environment"
                        }
                    });
                    break;
                case "only-video":
                    await scanner.updateVideoSettings({
                        video: true
                    });
                    break;
                default:
                    await scanner.updateVideoSettings({
                        video: {
                            width: {
                                ideal: 1280
                            },
                            height: {
                                ideal: 720
                            },
                            facingMode: {
                                ideal: "environment"
                            }
                        }
                    });
            }
        };
        for (let ipt of document.querySelectorAll('input[name="video-settings"]')) {
            ipt.addEventListener("change", switchVideoSettings);
        }
    </script>
</body>

</html>